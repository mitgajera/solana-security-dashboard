import React from 'react';
import { LineChart, Line, XAxis, YAxis, CartesianGrid, Tooltip, ResponsiveContainer } from 'recharts';
import { useExploitData } from '../../hooks/useExploitData';

// Move interfaces outside of the component
interface ExploitChartDataItem {
  name: string;
  value: number;
}

interface ChartMargin {
  top: number;
  right: number;
  left: number;
  bottom: number;
}

const ExploitFrequencyChart: React.FC = () => {
  const { exploits, loading, error } = useExploitData();

  if (loading) return <div className="p-4 text-center">Loading chart data...</div>;
  if (error) return <div className="p-4 text-center text-red-500">{error}</div>;

  // Process data to count exploits per month
  const exploitsByMonth: Record<string, number> = {};
  
  exploits.forEach(exploit => {
    const date = new Date(exploit.date);
    const monthYear = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
    
    if (!exploitsByMonth[monthYear]) {
      exploitsByMonth[monthYear] = 0;
    }
    exploitsByMonth[monthYear]++;
  });

  const chartData = Object.entries(exploitsByMonth)
    .map(([monthYear, count]) => {
      const [year, month] = monthYear.split('-');
      const monthNames = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
      return {
        name: `${monthNames[parseInt(month) - 1]} ${year}`,
        value: count,
      };
    })
    .sort((a, b) => a.name.localeCompare(b.name));

  return (
    <div className="h-80 w-full">
      <ResponsiveContainer width="100%" height="100%">
        <LineChart
          data={chartData}
          margin={{
            top: 20,
            right: 30,
            left: 20,
            bottom: 10,
          } as ChartMargin}
        >
          <CartesianGrid strokeDasharray="3 3" />
          <XAxis dataKey="name" />
          <YAxis allowDecimals={false} />
          <Tooltip formatter={(value: number) => [`${value} exploits`, 'Frequency']} />
          <Line type="monotone" dataKey="value" stroke="#8884d8" strokeWidth={2} />
        </LineChart>
      </ResponsiveContainer>
    </div>
  );
};

export default ExploitFrequencyChart;